# routing_tool.py

"""
Инструмент маршрутизации пациента на основе ФКР 2023 по сердечно-сосудистому риску.
"""

from typing import Optional


class RiskLevel:
    EXTREME = "Экстремальный"
    VERY_HIGH = "Очень высокий"
    HIGH = "Высокий"
    MODERATE = "Умеренный"
    LOW = "Низкий"
    UNKNOWN = "Недостаточно данных"


ROUTES = {
    RiskLevel.EXTREME: "Ведение в специализированном центре / федеральном центре / стационаре. Срочная маршрутизация.",
    RiskLevel.VERY_HIGH: "Направление к кардиологу / эндокринологу. Возможен дневной стационар или ЦАОП.",
    RiskLevel.HIGH: "Консультация профильного специалиста (амбулаторно). Ведение в КДЦ / межрайонном центре.",
    RiskLevel.MODERATE: "Ведение врачом общей практики / терапевтом. Наблюдение на уровне ПМСП.",
    RiskLevel.LOW: "Профилактическое наблюдение. Самоконтроль, контроль в ОВП / диспансеризация.",
    RiskLevel.UNKNOWN: "Требуется дополнительное обследование и повторная стратификация риска."
}


def classify_risk_and_route(
    has_multiple_events_in_2_years: bool = False,
    has_established_cvd: bool = False,
    has_severe_ckd: bool = False,
    has_diabetes_with_damage: bool = False,
    has_target_organ_damage: bool = False,
    has_early_onset_fh: bool = False,
    score2_percent: Optional[float] = None,
    age: Optional[int] = None
) -> dict:
    """
    Классификация сердечно-сосудистого риска и определение маршрута ведения пациента.
    """

    # Определение риска
    if has_multiple_events_in_2_years:
        risk = RiskLevel.EXTREME
    elif (
        has_established_cvd
        or has_severe_ckd
        or has_diabetes_with_damage
        or has_target_organ_damage
        or has_early_onset_fh
    ):
        risk = RiskLevel.VERY_HIGH
    elif score2_percent is not None:
        if score2_percent >= 10:
            risk = RiskLevel.VERY_HIGH
        elif score2_percent >= 5:
            risk = RiskLevel.HIGH
        elif age is not None:
            if (age < 50 and score2_percent < 2.5) or \
               (50 <= age < 69 and score2_percent < 5) or \
               (age >= 70 and score2_percent < 7.5):
                risk = RiskLevel.LOW
            else:
                risk = RiskLevel.MODERATE
        else:
            risk = RiskLevel.MODERATE
    else:
        risk = RiskLevel.UNKNOWN

    route = ROUTES[risk]
    return {
        "Категория риска": risk,
        "Рекомендованный маршрут": route
    }
